<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborations - SkillSprint</title>
  <link rel="stylesheet" href="assets/css/variables.css" />
  <link rel="stylesheet" href="assets/css/navbar.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ===================== BASE ===================== */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--base-bg, #F9F8D9);
      color: var(--text-dark, #1A1A1A);
      padding-bottom: 80px;
      min-height: 100vh;
    }

    /* ===================== CONTAINER ===================== */
    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===================== TOP BAR ===================== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;

      background: var(--sidebar-bg, #1A1A1A);
      padding: 14px 20px;
      border-radius: 20px;

      position: sticky;
      top: 16px;
      z-index: 50;

      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin: 16px 0 32px;

      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .back-btn {
      font-size: 1.2rem;
      cursor: pointer;
      padding: 10px;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent, #DCEF62);
      color: var(--text-dark, #1A1A1A);
      border: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);

      display: flex;
      align-items: center;
      justify-content: center;

      transition: all 0.2s ease;
      font-weight: 600;
    }

    .back-btn:hover {
      background: var(--sidebar-bg, #1A1A1A);
      color: var(--accent, #DCEF62);
      transform: translateX(-3px);
    }

    .platform-name {
      flex: 1;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-light, #fff);
      letter-spacing: 0.3px;
    }

    .search-box {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 10px 16px;
      width: 220px;
      border: 2px solid transparent;
      outline: none;

      font-size: 0.9rem;
      font-family: inherit;
      color: var(--text-light, #fff);

      transition: all 0.2s ease;
    }

    .search-box:focus {
      border-color: var(--accent, #DCEF62);
      background: rgba(255, 255, 255, 0.15);
    }

    .search-box::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* ===================== SECTION HEADINGS ===================== */
    .section-heading {
      margin: 40px 0 20px;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-dark, #1A1A1A);
      letter-spacing: 0.3px;
      text-align: center;
    }

    .section-heading:first-of-type {
      margin-top: 0;
    }

    /* ===================== CARD GRID ===================== */
    .collab-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      padding: 0;
    }

    /* ===================== CARDS ===================== */
    .collab-card {
      background: #ffffff;
      color: var(--text-dark, #1A1A1A);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      border: 1px solid rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .collab-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
      border-color: rgba(0, 0, 0, 0.15);
    }

    /* Top colored strip for visual interest without being overwhelming */
    .collab-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: var(--accent, #DCEF62);
      opacity: 0.8;
    }

    .card-header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .card-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text-dark, #1A1A1A);
      line-height: 1.3;
      margin: 0;
    }

    .card-type-icon {
      color: var(--text-light-2, #888);
      font-size: 1.5rem;
      /* Placeholder for icon */
    }

    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .meta-icon {
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .card-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .role-owner {
      background: rgba(220, 239, 98, 0.2);
      color: #7a8618;
      /* Darker accent */
      border: 1px solid rgba(220, 239, 98, 0.4);
    }

    .role-member {
      background: #f0f0f0;
      color: #666;
      border: 1px solid #e0e0e0;
    }

    .members-count {
      font-size: 0.85rem;
      color: #888;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Empty message */
    .empty-msg {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 1rem;
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 16px;
    }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 768px) {
      .page-container {
        padding: 0 16px;
      }

      .topbar {
        top: 12px;
        margin: 12px 16px 24px;
        padding: 12px 16px;
        border-radius: 16px;
      }

      .platform-name {
        font-size: 1.1rem;
      }

      .search-box {
        width: 160px;
        font-size: 0.85rem;
        padding: 8px 12px;
      }

      .collab-container {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .section-heading {
        font-size: 1.2rem;
        margin: 32px 0 16px;
      }
    }

    @media (max-width: 480px) {
      .back-btn {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
      }

      .search-box {
        display: none;
      }
    }

    .delete-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255, 77, 77, 0.1);
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 1.1rem;
      z-index: 10;
    }

    .delete-btn:hover {
      background: #ff4d4d;
      color: #fff;
      transform: rotate(90deg) scale(1.1);
    }
  </style>
</head>

<body>
  <div id="navbar-placeholder"></div>

  <div class="page-container">

    <!-- INVITATIONS -->
    <div class="section-heading" id="invitationHeading" style="display:none;">Pending Invitations</div>
    <div id="invitationList" class="collab-container"></div>

    <!-- WHITEBOARDS -->
    <div class="section-heading">Whiteboards</div>
    <div id="whiteboardList" class="collab-container"></div>

    <!-- PAIR PROGRAMMING -->
    <div class="section-heading">Pair-Programming</div>
    <div id="pairList" class="collab-container"></div>
  </div>

  <script src="js/config.js"></script>
  <script>
    let whiteboards = [];
    let pairProjects = [];

    document.addEventListener("DOMContentLoaded", async () => {
      // API_BASE is now global from config.js
      window.API_BASE = window.API_BASE_URL;

      const token = localStorage.getItem("token");
      if (!token) return alert("Please login first!");

      await loadWhiteboards(token);
      await loadPairProgramming(token);

      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        searchInput.addEventListener("input", () => filterResults(searchInput.value));
      }
    });

    // Expose for navbar-loader.js callback
    window.filterResultsGlobal = filterResults;

    /* ====================== FETCH WHITEBOARDS ====================== */
    async function loadWhiteboards(token) {
      const container = document.getElementById("whiteboardList");
      container.innerHTML = "<div class='empty-msg'>Loading whiteboards...</div>";

      try {
        const res = await fetch(`${window.API_BASE}/board/all`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        container.innerHTML = "";

        if (!data.success || !data.data.length) {
          container.innerHTML = "<div class='empty-msg'>No whiteboards found.</div>";
          return;
        }

        whiteboards = data.data;

        whiteboards.forEach(board => {
          const user = JSON.parse(localStorage.getItem("user"));
          const isOwner = board.owner?._id === user._id;

          container.appendChild(
            createCard(board, () => {
              window.location.href = `board.html?id=${board._id}`;
            }, isOwner, 'board')
          );
        });

      } catch (e) {
        console.error(e);
        container.innerHTML = "<div class='empty-msg'>Error loading whiteboards.</div>";
      }
    }

    /* ====================== FETCH PAIR PROGRAMMING ====================== */
    async function loadPairProgramming(token) {
      const container = document.getElementById("pairList");
      container.innerHTML = "<div class='empty-msg'>Loading pair-programming projects...</div>";

      try {
        const res = await fetch(`${window.API_BASE}/pair-programming/all`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        let data = await res.json();
        container.innerHTML = "";

        if (!Array.isArray(data) || !data.length) {
          container.innerHTML = "<div class='empty-msg'>No pair-programming projects found.</div>";
          return;
        }

        pairProjects = data;

        pairProjects.forEach(project => {
          const user = JSON.parse(localStorage.getItem("user"));
          const isOwner = project.owner?._id === user._id;

          container.appendChild(
            createCard(project, () => {
              window.location.href = `pair-programming.html?id=${project._id}`;
            }, isOwner, 'pair')
          );
        });

      } catch (e) {
        console.error(e);
        container.innerHTML = "<div class='empty-msg'>Error loading pair-programming projects.</div>";
      }
    }

    /* ====================== CARD UI ====================== */
    function createCard(item, onClick, isOwner, type) {
      const div = document.createElement("div");
      div.className = "collab-card";

      // Date Formatting
      const dateObj = new Date(item.updatedAt || item.createdAt);
      const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

      const roleText = isOwner ? 'Owner' : 'Member';
      const roleClass = isOwner ? 'role-owner' : 'role-member';

      // Calculate member count
      const members = item.members || [];
      const memberCount = members.length || 1;

      div.innerHTML = `
        ${isOwner ? `<button class="delete-btn" title="Delete"><i class="fa-solid fa-xmark"></i></button>` : ''}
        <div class="card-header">
           <h3 class="card-title">${item.name}</h3>
        </div>
        
        <div class="card-body">
            <div class="meta-row">
                <span>Created by <strong>${item.owner?.name || "Unknown"}</strong></span>
            </div>
            <div class="meta-row">
                <span>Last updated ${dateStr}</span>
            </div>
        </div>

        <div class="card-footer">
           <span class="role-badge ${roleClass}">${roleText}</span>
           <span class="members-count" title="${memberCount} members">
              ${memberCount} Members
           </span>
        </div>
      `;

      div.onclick = onClick;

      if (isOwner) {
        const delBtn = div.querySelector('.delete-btn');
        if (delBtn) {
          delBtn.onclick = async (e) => {
            e.stopPropagation();
            if (await showConfirm("Confirm Deletion", `Are you sure you want to delete "${item.name}"? This cannot be undone.`)) {
              deleteItem(item._id, type);
            }
          };
        }
      }
      return div;
    }


    async function deleteItem(id, type) {
      const endpoint = type === 'board' ? 'board' : 'pair-programming';
      try {
        const res = await fetch(`${window.API_BASE}/${endpoint}/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        const data = await res.json();
        if (data.success || res.ok) {
          showToast("Project deleted successfully", "success");
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(data.message || "Failed to delete item", "error");
        }
      } catch (e) {
        console.error(e);
        showToast("Error deleting project", "error");
      }
    }

    /* ====================== SEARCH FILTER ====================== */
    function filterResults(query) {
      const val = (typeof query === 'string' ? query : document.getElementById("searchInput")?.value || "").toLowerCase();

      filterList("whiteboardList", whiteboards, "board.html");
      filterList("pairList", pairProjects, "pair-programming.html");

      function filterList(containerId, array, page) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        const filtered = array.filter(x => x.name.toLowerCase().includes(val));

        if (!filtered.length) {
          container.innerHTML = "<div class='empty-msg'>No matches found.</div>";
          return;
        }

        filtered.forEach(item => {
          const user = JSON.parse(localStorage.getItem("user"));
          const isOwner = item.owner?._id === user._id;

          container.appendChild(
            createCard(item, () => {
              window.location.href = `${page}?id=${item._id}`;
            }, isOwner)
          );
        });
      }
    }
  </script>
  <script src="js/toast.js"></script>
  <script src="js/navbar-loader.js"></script>
  <script src="js/custom-dialog.js"></script>
  <script src="js/collaborations.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initNavbar({
        activePage: 'Collaborations',
        contextIcon: 'fa-puzzle-piece',
        backUrl: 'dashboard.html',
        searchPlaceholder: 'Search projects, whiteboards...',
        primaryAction: { show: false },
        search: {
          onInput: (val) => {
            if (window.filterResultsGlobal) {
              window.filterResultsGlobal(val);
            }
          }
        }
      });
    });
  </script>
</body>

</html>
```